{% extends "base.html" %}

{% block title %}Images - tgState{% endblock %}

{% block content %}
<div class="container">
    {% if not cfg.bot_ready %}
    <div class="ui-card ui-empty" style="margin-bottom: 14px;">
        <h2>功能未启用</h2>
        <p>上传/删除需要配置 BOT_TOKEN 与 CHANNEL_NAME。</p>
        {% if cfg.missing %}
        <ul>
            {% for item in cfg.missing %}
            <li>{{ item }} 未填写</li>
            {% endfor %}
        </ul>
        {% endif %}
        <div class="ui-btns" style="margin-top: 12px;">
            <a class="ui-btn primary" href="/settings">去 Settings</a>
        </div>
    </div>
    {% endif %}

    <h1>Images</h1>
    
    <!-- Upload Area -->
    <div class="upload-container">
        <div class="upload-area-dashed" id="upload-zone" data-bot-ready="{{ 1 if cfg.bot_ready else 0 }}">
            <p>拖拽图片到这里，或 <span>选择图片</span></p>
            <input type="file" id="file-picker" hidden multiple accept="image/*">
        </div>
        <div class="progress-area" id="prog-zone"></div>
        <div class="done-area" id="done-zone"></div>
    </div>

    <!-- Controls -->
    <div class="controls-bar">
        <div class="search-container">
            <input type="text" id="file-search" placeholder="Search images..." class="search-input">
        </div>
        
        <div class="batch-actions">
             <div class="link-format-selector" style="display: flex; gap: 8px; margin-right: 16px;">
                <button class="btn active format-option" data-format="url">URL</button>
                <button class="btn format-option" data-format="markdown">MD</button>
                <button class="btn format-option" data-format="html">HTML</button>
            </div>
            <button id="copy-links-btn" class="btn" disabled>Copy</button>
            <button id="batch-delete-btn" class="btn btn-danger" disabled>Delete</button>
        </div>
    </div>

    <!-- Image Grid -->
    <div class="file-list-container"> <!-- Reuse container for selection logic -->
        <!-- Hidden select all for logic compatibility -->
        <input type="checkbox" id="select-all-checkbox" style="display:none;">
        
        <div class="image-grid" id="file-list-disk">
            {% if files %}
                {% for file in files %}
                <div class="image-card file-item-disk" id="file-item-{{ file.file_id.replace(':', '-') }}" data-file-id="{{ file.file_id }}" data-file-url="/d/{{ file.file_id }}/{{ file.filename }}" data-filename="{{ file.filename }}">
                    <div class="image-thumb-wrapper">
                         <!-- In a real app, we'd have a thumbnail endpoint. Using direct link for now -->
                        <img src="/d/{{ file.file_id }}/{{ file.filename }}" loading="lazy" class="image-thumb" alt="{{ file.filename }}">
                         <div style="position: absolute; top: 8px; left: 8px;">
                            <input type="checkbox" class="file-checkbox" data-file-id="{{ file.file_id }}">
                        </div>
                    </div>
                    <div class="image-info">
                        <div class="image-name" title="{{ file.filename }}">{{ file.filename }}</div>
                        <div class="image-meta">{{ "%.2f" | format(file.filesize / (1024*1024)) }} MB</div>
                    </div>
                    <div class="image-actions">
                        <button class="action-btn copy-link-btn" data-tooltip="Copy" onclick="copyLink('/d/{{ file.file_id }}/{{ file.filename }}')">Copy</button>
                        <button class="action-btn delete" data-tooltip="Delete" onclick="deleteFile('{{ file.file_id }}')">Delete</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                 <div style="grid-column: 1/-1; padding: 40px; text-align: center; color: var(--text-tertiary);">
                    <p>No images found</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script src="{{ url_for('static', path='/js/main.js') }}?v=3.0"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('nav-image-hosting')?.classList.add('active');
});
</script>
{% endblock %}
